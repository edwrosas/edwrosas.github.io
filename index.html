<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dise√±a tus Imanes | Estudio Creativo</title>

    <!-- Fuentes -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Great+Vibes&family=Inter:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">

    <!-- SDK DE EMAILJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --secondary: #10B981;
            --bg-body: #F3F4F6;
            --surface: #ffffff;
            --text-main: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            margin: 0; padding: 15px;
            color: var(--text-main);
            line-height: 1.5;
        }

        .container {
            max-width: 950px; margin: 0 auto;
            background: var(--surface); padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            min-height: 80vh;
        }

        h2 { text-align: center; font-size: 1.6rem; margin-bottom: 25px; color: #111827; font-weight: 700; }

        /* --- STEPPER --- */
        .stepper-wrapper { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
        .stepper-wrapper::before { content: ''; position: absolute; top: 18px; left: 0; width: 100%; height: 3px; background: #E5E7EB; z-index: 0; }
        .stepper-item { position: relative; z-index: 1; text-align: center; background: var(--surface); padding: 0 10px; }
        .step-counter { width: 35px; height: 35px; border-radius: 50%; background: #fff; border: 3px solid #E5E7EB; color: #9CA3AF; display: flex; align-items: center; justify-content: center; margin: 0 auto 5px; font-weight: 700; font-size: 0.9rem; transition: all 0.3s ease; }
        .step-name { font-size: 0.75rem; font-weight: 600; color: #9CA3AF; }
        .stepper-item.active .step-counter { border-color: var(--primary); background: var(--primary); color: white; transform: scale(1.1); }
        .stepper-item.active .step-name { color: var(--primary); }
        .stepper-item.completed .step-counter { background: var(--secondary); border-color: var(--secondary); color: white; }

        .step-section { display: none; animation: fadeIn 0.4s ease-out; }
        .step-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- SUCCESS SCREEN (NUEVO) --- */
        #successSection { display: none; text-align: center; padding: 20px 0; }
        .success-icon { font-size: 4rem; color: var(--secondary); margin-bottom: 20px; display: block; }
        .btn-whatsapp {
            background-color: #25D366; color: white;
            font-size: 1.1rem; padding: 15px 30px;
            border-radius: 50px; text-decoration: none;
            display: inline-flex; align-items: center; gap: 10px;
            font-weight: bold; box-shadow: 0 10px 20px rgba(37, 211, 102, 0.3);
            transition: transform 0.2s; margin-top: 20px;
        }
        .btn-whatsapp:active { transform: scale(0.95); }

        /* --- GRID --- */
        .alert { background: #EFF6FF; border-left: 4px solid var(--primary); color: #1E40AF; padding: 12px; border-radius: 6px; margin-bottom: 20px; font-size: 0.9rem; }
        .grid-imanes { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .iman-slot { aspect-ratio: 1/1; background: #F9FAFB; border: 2px dashed #D1D5DB; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; }
        .iman-slot.filled { border: none; box-shadow: var(--shadow); background: white; }
        .iman-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* --- FORMS --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .full-width { grid-column: span 2; }
        label { font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 5px; display: block; }
        input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border); border-radius: 8px; font-size: 16px; /* Evita zoom en iOS */ background: #fff; font-family: 'Inter', sans-serif; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.1); }

        /* --- BOTONES --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-success { background: var(--secondary); color: white; }
        .btn:disabled { background: #D1D5DB; opacity: 0.7; cursor: not-allowed; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(3px); z-index: 100; justify-content: center; align-items: center; }
        .editor-container { background: white; width: 95%; max-width: 500px; border-radius: 16px; overflow: hidden; max-height: 95vh; display: flex; flex-direction: column; }

        .editor-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .editor-body { padding: 15px; overflow-y: auto; }

        .canvas-wrapper {
            width: 100%; aspect-ratio: 1/1;
            border: 4px solid #1F2937; border-radius: 4px;
            position: relative; background: #000;
            overflow: hidden; margin: 0 auto 20px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            touch-action: none; /* Vital para m√≥viles */
        }
        canvas { display: block; width: 100%; height: 100%; }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        input[type=range] { width: 100%; margin: 5px 0; }

        .editor-footer { padding: 15px; background: #F9FAFB; display: flex; gap: 10px; justify-content: flex-end; border-top: 1px solid #eee; }
        .btn-modal { padding: 10px 20px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; font-size: 0.9rem; }

        /* --- LOADER --- */
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 200; flex-direction: column; justify-content: center; align-items: center; text-align: center; padding: 20px; }
        .spinner { width: 40px; height: 40px; border: 4px solid #E5E7EB; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 600px) {
            .container { padding: 20px; margin: 10px; width: auto; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
            .btn { width: 100%; justify-content: center; }
            .controls-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<!-- PRECARGA DE FUENTES -->
<div style="font-family: 'Great Vibes', cursive; position:absolute; opacity:0; pointer-events:none;">.</div>
<div style="font-family: 'Pacifico', cursive; position:absolute; opacity:0; pointer-events:none;">.</div>
<div style="font-family: 'Fredoka', sans-serif; position:absolute; opacity:0; pointer-events:none;">.</div>

<!-- LOADER -->
<div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <h3 id="loaderText">Procesando...</h3>
    <p id="loaderSubtext" style="font-size: 0.9rem; color: #666;">Por favor no cierres la ventana</p>
</div>

<div class="container">

    <!-- CABECERA Y PASOS -->
    <div id="headerSection">
        <h2>Dise√±a tus Imanes 5x5</h2>
        <div class="stepper-wrapper">
            <div class="stepper-item active" id="step-indicator-1"><div class="step-counter">1</div><div class="step-name">Dise√±o</div></div>
            <div class="stepper-item" id="step-indicator-2"><div class="step-counter">2</div><div class="step-name">Entrega</div></div>
            <div class="stepper-item" id="step-indicator-3"><div class="step-counter">3</div><div class="step-name">Pago</div></div>
        </div>
    </div>

    <!-- PANTALLA DE √âXITO (Inicialmente oculta) -->
    <div id="successSection">
        <div class="success-icon">üéâ</div>
        <h2 style="color: var(--secondary); margin-bottom: 10px;">¬°Pedido Generado!</h2>
        <p style="color: #4B5563; font-size: 1.1rem; margin-bottom: 30px;">
            Las im√°genes se enviaron correctamente a nuestro sistema.
        </p>
        <p style="font-size: 0.9rem; color: #6B7280;">Para finalizar tu compra, env√≠anos el mensaje por WhatsApp:</p>

        <!-- BOT√ìN WHATSAPP FINAL -->
        <a href="#" id="finalWhatsappLink" class="btn-whatsapp" target="_blank">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12.031 6.172c-3.181 0-5.767 2.586-5.768 5.766-.001 1.298.38 2.27 1.019 3.287l-.711 2.598 2.669-.699c1.009.55 2.119.841 3.281.841h.001c3.182 0 5.768-2.587 5.769-5.767.001-3.181-2.587-5.767-5.768-5.767zm6.526 9.846c-.25.702-1.47 1.26-2.01 1.32-.54.059-1.24.23-4.32-1.002-3.87-1.55-6.46-5.74-6.65-5.99-.19-.25-1.59-2.11-1.59-4.03 0-1.92.99-2.86 1.34-3.25.35-.39.76-.49 1.01-.49.25 0 .5.01.71.01.22 0 .51-.08.8.61.29.7 1 2.45 1.09 2.63.09.18.15.4.04.63-.11.23-.17.37-.34.57-.17.2-.36.45-.51.6-.16.17-.33.35-.14.69.19.34.84 1.39 1.81 2.25 1.24 1.1 2.29 1.44 2.61 1.6.32.16.51.14.7-.07.19-.22.82-.96 1.04-1.29.22-.33.44-.27.74-.16.3.11 1.91.9 2.24 1.06.33.16.55.24.63.37.08.13.08.76-.17 1.46z"/></svg>
            Abrir WhatsApp y Enviar
        </a>

        <br><br>
        <button onclick="location.reload()" class="btn btn-secondary" style="margin-top: 20px; font-size: 0.9rem;">Crear otro pedido</button>
    </div>

    <form id="mainForm" onsubmit="return false;">

        <!-- PASO 1: DISE√ëO -->
        <div id="step-1" class="step-section active">
            <div class="alert">
                üëÜ <strong>Toca los cuadros grises</strong> para subir tus 8 fotos.
            </div>
            <div class="grid-imanes" id="gridImanes"></div>
            <div class="nav-buttons">
                <div></div>
                <button class="btn btn-primary" id="btnNext1" onclick="nextStep(2)" disabled>Siguiente ‚Üí</button>
            </div>
        </div>

        <!-- PASO 2: ENTREGA -->
        <div id="step-2" class="step-section">
            <h3>Datos de Entrega</h3>
            <div class="form-grid">
                <div><label>Nombres</label><input type="text" id="ship_name"></div>
                <div><label>Apellidos</label><input type="text" id="ship_surname"></div>
                <div><label>Identificaci√≥n</label><input type="text" id="ship_id"></div>
                <div><label>Celular</label><input type="tel" id="ship_phone"></div>
                <div class="full-width"><label>Email</label><input type="email" id="ship_email"></div>
                <div class="full-width"><label>Direcci√≥n</label><input type="text" id="ship_address"></div>
                <div class="full-width"><label>Referencias</label><textarea id="ship_comments" rows="2"></textarea></div>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="prevStep(1)">‚Üê Atr√°s</button>
                <button class="btn btn-primary" onclick="validateAndNext(2)">Siguiente ‚Üí</button>
            </div>
        </div>

        <!-- PASO 3: PAGO -->
        <div id="step-3" class="step-section">
            <h3>Pago</h3>
            <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #E5E7EB;">
                <input type="checkbox" id="same_data" onchange="copyShippingData()" style="width:auto; margin-right:10px;">
                <label for="same_data" style="display:inline;">Usar mismos datos para factura</label>
            </div>
            <div class="form-grid">
                <div><label>Nombres</label><input type="text" id="bill_name"></div>
                <div><label>Apellidos</label><input type="text" id="bill_surname"></div>
                <div><label>Identificaci√≥n</label><input type="text" id="bill_id"></div>
                <div><label>Celular</label><input type="tel" id="bill_phone"></div>
                <div class="full-width"><label>Email</label><input type="email" id="bill_email"></div>
                <div class="full-width"><label>Direcci√≥n</label><input type="text" id="bill_address"></div>
            </div>
            <div style="margin-top: 25px;">
                <input type="checkbox" id="terms" required style="width:auto; margin-right:10px;">
                <label for="terms" style="display:inline; color: var(--text-light); font-size:0.9rem;">Acepto el <a href="#" style="color:var(--primary)">tratamiento de datos</a>.</label>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="prevStep(2)">‚Üê Atr√°s</button>
                <button class="btn btn-success" onclick="processOrderCloudinary()">Finalizar Pedido</button>
            </div>
        </div>
    </form>
</div>

<!-- EDITOR MODAL -->
<div class="modal" id="editorModal">
    <div class="editor-container">
        <div class="editor-header">
            <h3 style="margin:0; font-size: 1.1rem;">Editando Im√°n #<span id="currentSlotNum"></span></h3>
            <button onclick="closeEditor()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">&times;</button>
        </div>

        <div class="editor-body">
            <div class="canvas-wrapper">
                <canvas id="editorCanvas" width="300" height="300"></canvas>
            </div>
            <p style="font-size: 0.8rem; text-align: center; margin-bottom: 20px; background: #f0fdf4; padding: 8px; border-radius: 6px; color: #166534;">
                üëÜ <strong>Tip:</strong> Mueve la foto o el texto con el dedo.
            </p>

            <div class="controls-grid">
                <div class="full-width">
                    <label>1. Cambiar Foto</label>
                    <input type="file" id="imageUpload" accept="image/*">
                </div>

                <div class="full-width">
                    <label>2. Zoom</label>
                    <input type="range" id="zoomControl" min="0.5" max="2" step="0.10" value="1">
                </div>

                <div class="full-width" style="border-top: 1px solid #eee; padding-top: 15px;">
                    <label>3. Texto</label>
                    <input type="text" id="textInput" placeholder="Ej: Feliz D√≠a">
                </div>

                <div>
                    <label>Fuente</label>
                    <select id="fontFamily">
                        <option value="Arial">Arial</option>
                        <option value="'Great Vibes', cursive">My Love</option>
                        <option value="'Pacifico', cursive">Anastasia</option>
                        <option value="'Fredoka', sans-serif">Moderna</option>
                        <option value="'Inter', sans-serif">Simple</option>
                        <option value="Times New Roman">Cl√°sica</option>
                        <option value="Impact">Negrita</option>
                    </select>
                </div>

                <div>
                    <label>Color</label>
                    <div style="display:flex; align-items:center; height:42px; border:1px solid var(--border); border-radius:8px; padding:0 5px;">
                        <input type="color" id="fontColor" value="#ffffff" style="width:100%; height:30px; border:none; padding:0; background:none;">
                    </div>
                </div>

                <div class="full-width">
                    <label>Tama√±o Texto</label>
                    <input type="range" id="fontSize" min="10" max="80" value="40">
                </div>
            </div>
        </div>

        <div class="editor-footer">
            <button class="btn-modal" style="background:#eee; color:#333" onclick="closeEditor()">Cancelar</button>
            <button class="btn-modal" style="background:var(--secondary); color:white" onclick="saveSlot()">Guardar</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  1. CONFIGURACI√ìN DE EMAILJS
    // ==========================================
    const EMAILJS_PUBLIC_KEY = "ain0jDyCXgCAFURqg";
    const EMAILJS_SERVICE_ID = "service_gz97y8p";
    const EMAILJS_TEMPLATE_ID = "template_k2u0fxd";

    // ==========================================
    //  2. CONFIGURACI√ìN DE CLOUDINARY
    // ==========================================
    const CLOUDINARY_CLOUD_NAME = "dwtdqotop";
    const CLOUDINARY_UPLOAD_PRESET = "imagen";
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    const SHOP_CONFIG = {
        whatsappNumber: "593986805369",
        price: 16.00,
        shippingCost: 3.00
    };

    (function(){ emailjs.init(EMAILJS_PUBLIC_KEY); })();

    // --- ESTADO GLOBAL ---
    let slots = new Array(8).fill(null);
    let currentSlotIndex = -1;
    let imgObject = new Image();
    let canvas = document.getElementById('editorCanvas');
    let ctx = canvas.getContext('2d');

    let defaultState = {
        x: 0, y: 0, scale: 1,
        text: "", fontSize: 40, fontFamily: "Arial", color: "#ffffff",
        textX: 150, textY: 150,
        draggingTarget: null, lastX: 0, lastY: 0
    };
    let editorState = { ...defaultState };

    window.onload = function() { renderGrid(); };

    function renderGrid() {
        const container = document.getElementById('gridImanes');
        container.innerHTML = '';
        slots.forEach((slot, index) => {
            const div = document.createElement('div');
            div.className = `iman-slot ${slot ? 'filled' : ''}`;
            div.onclick = () => openEditor(index);
            if (slot) {
                const img = document.createElement('img');
                img.src = slot.previewData;
                div.appendChild(img);
            } else {
                div.innerHTML = `
                    <div style="font-size:2rem; color:#D1D5DB; line-height:1;">+</div>
                    <small style="color:#6B7280; font-size:0.75rem; margin-top:5px;">Foto ${index + 1}</small>
                `;
            }
            container.appendChild(div);
        });
        checkStep1Validity();
    }

    function openEditor(index) {
        currentSlotIndex = index;
        document.getElementById('currentSlotNum').innerText = index + 1;
        document.getElementById('editorModal').style.display = 'flex';
        if (slots[index]) {
            imgObject.src = slots[index].originalSrc;
            editorState = { ...slots[index].editorState };
            if(editorState.textX === undefined) editorState.textX = 150;
            if(editorState.textY === undefined) editorState.textY = 150;
            loadControls();
        } else {
            resetEditor();
        }
    }

    function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }

    function resetEditor() {
        imgObject = new Image(); imgObject.src = "";
        editorState = { ...defaultState };
        document.getElementById('imageUpload').value = "";
        document.getElementById('textInput').value = "";
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000"; ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.font = "bold 16px Inter"; ctx.fillStyle="#666"; ctx.textAlign="center";
        ctx.fillText("Sube una foto", 150, 140);
        ctx.font = "30px Inter"; ctx.fillText("üì∑", 150, 180);
    }

    function loadControls() {
        document.getElementById('zoomControl').value = editorState.scale;
        document.getElementById('textInput').value = editorState.text;
        document.getElementById('fontSize').value = editorState.fontSize;
        document.getElementById('fontFamily').value = editorState.fontFamily;
        document.getElementById('fontColor').value = editorState.color;
    }

    function drawCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000"; ctx.fillRect(0, 0, canvas.width, canvas.height);

        if (imgObject.src) {
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(editorState.scale, editorState.scale);
            ctx.translate(-canvas.width/2, -canvas.height/2);
            ctx.drawImage(imgObject, editorState.x, editorState.y);
            ctx.restore();
        }

        if (editorState.text) {
            ctx.save();
            ctx.font = `${editorState.fontSize}px ${editorState.fontFamily}`;
            ctx.fillStyle = editorState.color;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(editorState.text, editorState.textX, editorState.textY);
            ctx.restore();
        }
    }

    document.getElementById('imageUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                imgObject = new Image();
                imgObject.onload = () => {
                    const ratioW = canvas.width / imgObject.width;
                    const ratioH = canvas.height / imgObject.height;
                    let newScale = Math.max(ratioW, ratioH) * 1.1;
                    editorState.scale = newScale;
                    document.getElementById('zoomControl').value = newScale;
                    editorState.x = (canvas.width - imgObject.width) / 2;
                    editorState.y = (canvas.height - imgObject.height) / 2;
                    drawCanvas();
                };
                imgObject.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    ['zoomControl', 'textInput', 'fontSize', 'fontFamily', 'fontColor'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
            if (id === 'zoomControl') editorState.scale = parseFloat(e.target.value);
            if (id === 'textInput') {
                editorState.text = e.target.value;
                if(editorState.text && editorState.textX === 0) {
                    editorState.textX = canvas.width / 2;
                    editorState.textY = canvas.height / 2;
                }
            }
            if (id === 'fontSize') editorState.fontSize = parseInt(e.target.value);
            if (id === 'fontFamily') editorState.fontFamily = e.target.value;
            if (id === 'fontColor') editorState.color = e.target.value;
            drawCanvas();
        });
    });

    // --- TOUCH & MOUSE LOGIC ---
    function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    function handleStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pos = getPointerPos(e);
        editorState.lastX = pos.x;
        editorState.lastY = pos.y;

        let hitText = false;
        if (editorState.text) {
            ctx.font = `${editorState.fontSize}px ${editorState.fontFamily}`;
            const metrics = ctx.measureText(editorState.text);
            const txtW = metrics.width;
            const txtH = editorState.fontSize;
            const left = editorState.textX - txtW/2 - 20;
            const right = editorState.textX + txtW/2 + 20;
            const top = editorState.textY - txtH/2 - 20;
            const bottom = editorState.textY + txtH/2 + 20;
            if (pos.x >= left && pos.x <= right && pos.y >= top && pos.y <= bottom) hitText = true;
        }

        if (hitText) editorState.draggingTarget = 'text';
        else if (imgObject.src) editorState.draggingTarget = 'image';
        else editorState.draggingTarget = null;
    }

    function handleMove(e) {
        if (!editorState.draggingTarget) return;
        if(e.type === 'touchmove') e.preventDefault();
        const pos = getPointerPos(e);
        const dx = pos.x - editorState.lastX;
        const dy = pos.y - editorState.lastY;
        if (editorState.draggingTarget === 'text') { editorState.textX += dx; editorState.textY += dy; }
        else if (editorState.draggingTarget === 'image') { editorState.x += dx; editorState.y += dy; }
        editorState.lastX = pos.x;
        editorState.lastY = pos.y;
        drawCanvas();
    }

    function handleEnd(e) { editorState.draggingTarget = null; }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchend', handleEnd);

    function saveSlot() {
        if (!imgObject.src) return alert("Carga una imagen primero");
        const finalImage = canvas.toDataURL('image/jpeg', 1.0);
        slots[currentSlotIndex] = { previewData: finalImage, originalSrc: imgObject.src, editorState: { ...editorState } };
        closeEditor(); renderGrid();
    }

    function checkStep1Validity() {
        const btn = document.getElementById('btnNext1');
        const count = slots.filter(s => s).length;
        btn.disabled = count !== 8;
        btn.innerHTML = count === 8 ? 'Siguiente ‚Üí' : `Faltan ${8 - count}`;
        btn.style.opacity = count !== 8 ? "0.6" : "1";
    }

    function nextStep(n) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        window.scrollTo({top:0, behavior: 'smooth'});
        for(let i=1; i<=3; i++) {
            const el = document.getElementById(`step-indicator-${i}`);
            el.className = `stepper-item ${i === n ? 'active' : (i < n ? 'completed' : '')}`;
        }
    }
    function prevStep(n) { nextStep(n); }

    function validateAndNext(n) {
        if (n === 2) {
            let valid = true;
            ['ship_name','ship_surname','ship_id','ship_phone','ship_email','ship_address'].forEach(id => {
                const el = document.getElementById(id);
                if(!el.value) { el.style.borderColor = "#EF4444"; valid = false; }
                else el.style.borderColor = "#E5E7EB";
            });
            if(valid) nextStep(3); else alert("Por favor completa los campos obligatorios.");
        }
    }

    function copyShippingData() {
        const checked = document.getElementById('same_data').checked;
        ['name','surname','id','phone','email','address'].forEach(f => {
            const val = document.getElementById(`ship_${f}`).value;
            const target = document.getElementById(`bill_${f}`);
            if(checked) { target.value = val; target.readOnly = true; target.style.background = "#F3F4F6"; }
            else { target.value = ""; target.readOnly = false; target.style.background = "#fff"; }
        });
    }

    async function uploadToCloudinary(base64Image) {
        const formData = new FormData();
        formData.append("file", base64Image);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
        try {
            const response = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
            if(!response.ok) throw new Error("Error Cloudinary");
            const data = await response.json();
            return data.secure_url;
        } catch (error) { console.error(error); return null; }
    }

    async function processOrderCloudinary() {
        const required = ['bill_name', 'bill_surname', 'bill_id', 'bill_email', 'bill_phone', 'bill_address'];
        if (required.some(id => !document.getElementById(id).value)) return alert("Completa la facturaci√≥n");
        if (!document.getElementById('terms').checked) return alert("Acepta t√©rminos");

        const loader = document.getElementById('loader');
        loader.style.display = 'flex';

        const nombre = document.getElementById('ship_name').value + " " + document.getElementById('ship_surname').value;
        const email = document.getElementById('ship_email').value;
        const total = (SHOP_CONFIG.price + SHOP_CONFIG.shippingCost).toFixed(2);

        try {
            const uploadPromises = slots.map(async (slot) => await uploadToCloudinary(slot.previewData));
            const imageUrls = await Promise.all(uploadPromises);

            if(imageUrls.some(url => url === null)) throw new Error("Fallo subida de im√°genes");

            const templateParams = {
                cust_name: nombre, cust_surname: document.getElementById('ship_surname').value,
                cust_email: email, cust_phone: document.getElementById('ship_phone').value,
                cust_address: document.getElementById('ship_address').value,
                total_price: "$" + total,
                img1_link: imageUrls[0], img2_link: imageUrls[1], img3_link: imageUrls[2], img4_link: imageUrls[3],
                img5_link: imageUrls[4], img6_link: imageUrls[5], img7_link: imageUrls[6], img8_link: imageUrls[7]
            };

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

            // OCULTAR LOADER Y MOSTRAR PANTALLA DE EXITO
            loader.style.display = 'none';

            // Generar link de WhatsApp
            const msjWA = `Hola, soy ${nombre}. Ya realic√© mi pedido de 8 imanes (Total $${total}). Las im√°genes fueron enviadas a su sistema. Quedo atento para el pago.`;
            const urlWA = `https://api.whatsapp.com/send?phone=${SHOP_CONFIG.whatsappNumber}&text=${encodeURIComponent(msjWA)}`;

            // Configurar bot√≥n final
            document.getElementById('finalWhatsappLink').href = urlWA;

            // Cambiar Vistas
            document.getElementById('mainForm').style.display = 'none';
            document.getElementById('headerSection').style.display = 'none';
            document.getElementById('successSection').style.display = 'block';

            // Intentar abrir autom√°ticamente (por si acaso funciona en desktop)
            window.location.href = urlWA;

        } catch (error) {
            loader.style.display = 'none';
            alert("Hubo un error: " + error.message);
        }
    }
</script>

</body>
</html>