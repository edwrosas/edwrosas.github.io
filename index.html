<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dise√±a tus Imanes | Estudio Creativo</title>

    <!-- FUENTES DE GOOGLE AGREGADAS AQUI -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Great+Vibes&family=Inter:wght@300;400;500;600;700&family=Pacifico&display=swap" rel="stylesheet">

    <!-- SDK DE EMAILJS -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338ca;
            --secondary: #10B981;
            --bg-body: #F3F4F6;
            --surface: #ffffff;
            --text-main: #1F2937;
            --text-light: #6B7280;
            --border: #E5E7EB;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            margin: 0;
            padding: 20px;
            color: var(--text-main);
            line-height: 1.5;
        }

        .container {
            max-width: 950px;
            margin: 20px auto;
            background: var(--surface);
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        h2 { text-align: center; font-size: 1.8rem; margin-bottom: 30px; color: #111827; font-weight: 700; }
        h3 { color: #111827; margin-top: 0; font-weight: 700; }

        /* --- STEPPER --- */
        .stepper-wrapper { display: flex; justify-content: space-between; margin-bottom: 50px; position: relative; }
        .stepper-wrapper::before { content: ''; position: absolute; top: 20px; left: 0; width: 100%; height: 4px; background: #E5E7EB; z-index: 0; border-radius: 10px; }
        .stepper-item { position: relative; z-index: 1; text-align: center; background: var(--surface); padding: 0 15px; }
        .step-counter { width: 40px; height: 40px; border-radius: 50%; background: #fff; border: 3px solid #E5E7EB; color: #9CA3AF; display: flex; align-items: center; justify-content: center; margin: 0 auto 8px; font-weight: 700; transition: all 0.3s ease; }
        .step-name { font-size: 0.85rem; font-weight: 600; color: #9CA3AF; transition: color 0.3s; }
        .stepper-item.active .step-counter { border-color: var(--primary); background: var(--primary); color: white; transform: scale(1.1); box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.2); }
        .stepper-item.active .step-name { color: var(--primary); }
        .stepper-item.completed .step-counter { background: var(--secondary); border-color: var(--secondary); color: white; }

        .step-section { display: none; animation: slideUp 0.4s ease-out; }
        .step-section.active { display: block; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* --- GRID --- */
        .alert { background: #EFF6FF; border-left: 4px solid var(--primary); color: #1E40AF; padding: 15px; border-radius: 6px; margin-bottom: 30px; font-size: 0.95rem; }
        .grid-imanes { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 25px; margin-bottom: 40px; }
        .iman-slot { aspect-ratio: 1 / 1; background: #F9FAFB; border: 2px dashed #D1D5DB; border-radius: 16px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; overflow: hidden; position: relative; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .iman-slot:hover { border-color: var(--primary); background: #EEF2FF; transform: translateY(-4px); }
        .iman-slot.filled { border: none; background: white; box-shadow: var(--shadow); }
        .iman-slot img { width: 100%; height: 100%; object-fit: cover; }

        /* --- FORMS --- */
        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .full-width { grid-column: span 2; }
        label { font-size: 0.85rem; font-weight: 600; color: #374151; margin-bottom: 6px; display: block; }
        input[type="text"], input[type="email"], input[type="tel"], textarea, select { width: 100%; padding: 12px 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; background: #fff; transition: all 0.2s; font-family: 'Inter', sans-serif; }
        input:focus, textarea:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }

        /* --- BOTONES --- */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border); }
        .btn { padding: 12px 28px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 1rem; transition: all 0.2s; display: inline-flex; align-items: center; gap: 8px; }
        .btn-primary { background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.25); }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); }
        .btn-success { background: var(--secondary); color: white; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25); }
        .btn-success:hover { background: #059669; transform: translateY(-1px); }
        .btn-secondary { background: #E5E7EB; color: #374151; }
        .btn-secondary:hover { background: #D1D5DB; }
        .btn:disabled { background: #D1D5DB; color: #9CA3AF; cursor: not-allowed; transform: none; box-shadow: none; }

        /* --- MODAL --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px); z-index: 100; justify-content: center; align-items: center; }
        .editor-container { background: white; padding: 30px; border-radius: 16px; width: 95%; max-width: 850px; display: flex; flex-direction: column; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .editor-body { display: flex; flex-wrap: wrap; gap: 40px; margin-top: 20px; }
        .col-preview { flex: 0 0 auto; width: 100%; max-width: 320px; margin: 0 auto; }
        .col-controls { flex: 1; min-width: 300px; }

        .canvas-wrapper {
            width: 100%;
            aspect-ratio: 1/1;
            border: 4px solid #1F2937;
            border-radius: 4px;
            position: relative;
            background: #000000;
            overflow: hidden;
            cursor: move;
            touch-action: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        canvas {
            display: block;
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
        }

        .controls-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; height: 18px; width: 18px; border-radius: 50%; background: var(--primary); margin-top: -7px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #E5E7EB; border-radius: 2px; }
        input[type="file"]::file-selector-button { margin-right: 10px; border: none; background: var(--primary); padding: 8px 12px; border-radius: 6px; color: #fff; cursor: pointer; font-size: 0.85rem; transition: background .2s ease-in-out; }
        input[type="file"]::file-selector-button:hover { background: var(--primary-hover); }

        .editor-footer { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 12px; }

        /* --- LOADER --- */
        .loader-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(5px); z-index: 200; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #E5E7EB; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        @media (max-width: 768px) {
            .container { padding: 20px; margin: 10px; }
            .editor-body { flex-direction: column; }
            .col-preview, .col-controls { width: 100%; max-width: 100%; }
            .form-grid { grid-template-columns: 1fr; }
            .full-width { grid-column: span 1; }
        }
    </style>
</head>
<body>

<!-- PRECARGA DE FUENTES OCULTA (Vital para Canvas) -->
<div style="font-family: 'Great Vibes', cursive; position:absolute; opacity:0; pointer-events:none;">.</div>
<div style="font-family: 'Pacifico', cursive; position:absolute; opacity:0; pointer-events:none;">.</div>
<div style="font-family: 'Fredoka', sans-serif; position:absolute; opacity:0; pointer-events:none;">.</div>

<!-- LOADER -->
<div class="loader-overlay" id="loader">
    <div class="spinner"></div>
    <h3 id="loaderText" style="color: var(--text-main);">Procesando...</h3>
    <p id="loaderSubtext" style="color: var(--text-light);">Optimizando im√°genes y subiendo a la nube...</p>
</div>

<div class="container">
    <h2>Dise√±a tus Imanes 5x5</h2>

    <!-- STEPPER -->
    <div class="stepper-wrapper">
        <div class="stepper-item active" id="step-indicator-1"><div class="step-counter">1</div><div class="step-name">Dise√±o</div></div>
        <div class="stepper-item" id="step-indicator-2"><div class="step-counter">2</div><div class="step-name">Entrega</div></div>
        <div class="stepper-item" id="step-indicator-3"><div class="step-counter">3</div><div class="step-name">Pago</div></div>
    </div>

    <form id="mainForm" onsubmit="return false;">

        <!-- PASO 1: DISE√ëO -->
        <div id="step-1" class="step-section active">
            <div class="alert">
                <strong>Instrucciones:</strong> Haz clic en cada cuadro para cargar tu foto.
            </div>
            <div class="grid-imanes" id="gridImanes"></div>
            <div class="nav-buttons">
                <div></div>
                <button class="btn btn-primary" id="btnNext1" onclick="nextStep(2)" disabled>Siguiente Paso <span style="font-size:1.2em">‚Üí</span></button>
            </div>
        </div>

        <!-- PASO 2: ENTREGA -->
        <div id="step-2" class="step-section">
            <h3>Datos de Entrega</h3>
            <div class="form-grid">
                <div><label>Nombres</label><input type="text" id="ship_name"></div>
                <div><label>Apellidos</label><input type="text" id="ship_surname"></div>
                <div><label>Identificaci√≥n / DNI</label><input type="text" id="ship_id"></div>
                <div><label>Tel√©fono Celular</label><input type="tel" id="ship_phone"></div>
                <div class="full-width"><label>Email</label><input type="email" id="ship_email"></div>
                <div class="full-width"><label>Direcci√≥n Exacta</label><input type="text" id="ship_address"></div>
                <div class="full-width"><label>Referencias / Comentarios</label><textarea id="ship_comments" rows="2"></textarea></div>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="prevStep(1)">‚Üê Atr√°s</button>
                <button class="btn btn-primary" onclick="validateAndNext(2)">Siguiente Paso ‚Üí</button>
            </div>
        </div>

        <!-- PASO 3: PAGO -->
        <div id="step-3" class="step-section">
            <h3>Facturaci√≥n y Pago</h3>
            <div style="background: #F9FAFB; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #E5E7EB;">
                <input type="checkbox" id="same_data" onchange="copyShippingData()" style="width:auto; margin-right:10px;">
                <label for="same_data" style="display:inline; font-weight:400;">Usar los mismos datos de entrega</label>
            </div>
            <div class="form-grid">
                <div><label>Nombres</label><input type="text" id="bill_name"></div>
                <div><label>Apellidos</label><input type="text" id="bill_surname"></div>
                <div><label>Identificaci√≥n</label><input type="text" id="bill_id"></div>
                <div><label>Tel√©fono</label><input type="tel" id="bill_phone"></div>
                <div class="full-width"><label>Email</label><input type="email" id="bill_email"></div>
                <div class="full-width"><label>Direcci√≥n</label><input type="text" id="bill_address"></div>
            </div>
            <div style="margin-top: 30px;">
                <input type="checkbox" id="terms" required style="width:auto; margin-right:10px;">
                <label for="terms" style="display:inline; color: var(--text-light); font-size:0.9rem;">He le√≠do y acepto el <a href="#" style="color:var(--primary)">tratamiento de datos personales</a>.</label>
            </div>
            <div class="nav-buttons">
                <button class="btn btn-secondary" onclick="prevStep(2)">‚Üê Atr√°s</button>
                <button class="btn btn-success" onclick="processOrderCloudinary()">Finalizar y Pagar (WhatsApp)</button>
            </div>
        </div>
    </form>
</div>

<!-- EDITOR MODAL -->
<div class="modal" id="editorModal">
    <div class="editor-container">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #eee; padding-bottom:15px;">
            <h3 style="margin:0;">Editando Im√°n #<span id="currentSlotNum"></span></h3>
            <button onclick="closeEditor()" style="background:none; border:none; font-size:1.5rem; cursor:pointer; color:#999;">&times;</button>
        </div>

        <div class="editor-body">
            <!-- Preview -->
            <div class="col-preview">
                <div class="canvas-wrapper">
                    <canvas id="editorCanvas" width="300" height="300"></canvas>
                </div>
                <p style="font-size: 0.8rem; text-align: center; margin-top: 8px; color: #6B7280; background: #f0fdf4; padding: 5px; border-radius: 5px; border: 1px solid #bbf7d0; color: #166534;">
                    üëã <strong>Tip:</strong> Arrastra con el dedo/mouse para ajustar.
                </p>
            </div>

            <!-- Controls -->
            <div class="col-controls">
                <div class="controls-grid">
                    <div class="full-span">
                        <label>1. Seleccionar Foto</label>
                        <input type="file" id="imageUpload" accept="image/*">
                    </div>

                    <div class="full-span">
                        <label>2. Zoom Foto</label>
                        <input type="range" id="zoomControl" min="0.05" max="5" step="0.05" value="1">
                    </div>

                    <div class="full-span" style="border-top: 1px solid #eee; padding-top: 15px; margin-top: 5px;">
                        <label>3. Texto (Arrastra para mover)</label>
                        <input type="text" id="textInput" placeholder="Ej: Mi Cumplea√±os">
                    </div>

                    <!-- SELECCION DE FUENTES NUEVA -->
                    <div>
                        <label>Fuente</label>
                        <select id="fontFamily">
                            <option value="Arial">Arial</option>
                            <option value="'Great Vibes', cursive">My Love (Elegante)</option>
                            <option value="'Pacifico', cursive">Anastasia (Manuscrita)</option>
                            <option value="'Fredoka', sans-serif">Moderna (Redonda)</option>
                            <option value="'Inter', sans-serif">Inter (Limpia)</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Impact">Impact (Gruesa)</option>
                        </select>
                    </div>

                    <div>
                        <label>Color</label>
                        <div style="display:flex; align-items:center; height:42px; border:1px solid var(--border); border-radius:8px; padding:0 5px;">
                            <input type="color" id="fontColor" value="#ffffff" style="width:100%; height:30px; border:none; padding:0; background:none;">
                        </div>
                    </div>

                    <div class="full-span">
                        <label>Tama√±o Texto</label>
                        <input type="range" id="fontSize" min="10" max="80" value="40">
                    </div>
                </div>
            </div>
        </div>

        <div class="editor-footer">
            <button class="btn btn-secondary" onclick="closeEditor()">Cancelar</button>
            <button class="btn btn-success" onclick="saveSlot()">Guardar Cambios</button>
        </div>
    </div>
</div>

<script>
    // ==========================================
    //  1. CONFIGURACI√ìN DE EMAILJS (PON TUS DATOS)
    // ==========================================
    const EMAILJS_PUBLIC_KEY = "ain0jDyCXgCAFURqg";
    const EMAILJS_SERVICE_ID = "service_gz97y8p";
    const EMAILJS_TEMPLATE_ID = "template_k2u0fxd";

    // ==========================================
    //  2. CONFIGURACI√ìN DE CLOUDINARY (PON TUS DATOS)
    // ==========================================
    const CLOUDINARY_CLOUD_NAME = "dwtdqotop";
    const CLOUDINARY_UPLOAD_PRESET = "imagen";
    const CLOUDINARY_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;

    const SHOP_CONFIG = {
        whatsappNumber: "593986805369",
        price: 16.00,
        shippingCost: 0.00
    };

    (function(){ emailjs.init(EMAILJS_PUBLIC_KEY); })();

    // --- ESTADO GLOBAL ---
    let slots = new Array(8).fill(null);
    let currentSlotIndex = -1;
    let imgObject = new Image();
    let canvas = document.getElementById('editorCanvas');
    let ctx = canvas.getContext('2d');

    let defaultState = {
        x: 0, y: 0, scale: 1,
        text: "", fontSize: 40, fontFamily: "Arial", color: "#ffffff",
        textX: 150, textY: 150,
        draggingTarget: null,
        lastX: 0, lastY: 0
    };
    let editorState = { ...defaultState };

    window.onload = function() { renderGrid(); };

    function renderGrid() {
        const container = document.getElementById('gridImanes');
        container.innerHTML = '';
        slots.forEach((slot, index) => {
            const div = document.createElement('div');
            div.className = `iman-slot ${slot ? 'filled' : ''}`;
            div.onclick = () => openEditor(index);
            if (slot) {
                const img = document.createElement('img');
                img.src = slot.previewData;
                div.appendChild(img);
            } else {
                div.innerHTML = `
                    <div style="font-size:2rem; color:#D1D5DB; line-height:1;">+</div>
                    <small style="color:#6B7280; font-size:0.8rem;">Im√°n ${index + 1}</small>
                `;
            }
            container.appendChild(div);
        });
        checkStep1Validity();
    }

    function openEditor(index) {
        currentSlotIndex = index;
        document.getElementById('currentSlotNum').innerText = index + 1;
        document.getElementById('editorModal').style.display = 'flex';
        if (slots[index]) {
            imgObject.src = slots[index].originalSrc;
            editorState = { ...slots[index].editorState };
            if(editorState.textX === undefined) editorState.textX = 150;
            if(editorState.textY === undefined) editorState.textY = 150;
            loadControls();
        } else {
            resetEditor();
        }
    }

    function closeEditor() { document.getElementById('editorModal').style.display = 'none'; }

    function resetEditor() {
        imgObject = new Image(); imgObject.src = "";
        editorState = { ...defaultState };
        document.getElementById('imageUpload').value = "";
        document.getElementById('textInput').value = "";
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // Rellenar de negro para evitar brillos
        ctx.fillStyle = "#000000"; ctx.fillRect(0,0,canvas.width, canvas.height);

        ctx.font = "bold 16px Inter"; ctx.fillStyle="#666"; ctx.textAlign="center";
        ctx.fillText("Sube una foto", 150, 140);
        ctx.font = "30px Inter"; ctx.fillText("üì∑", 150, 180);
    }

    function loadControls() {
        document.getElementById('zoomControl').value = editorState.scale;
        document.getElementById('textInput').value = editorState.text;
        document.getElementById('fontSize').value = editorState.fontSize;
        document.getElementById('fontFamily').value = editorState.fontFamily;
        document.getElementById('fontColor').value = editorState.color;
    }

    // --- DIBUJO CANVAS ---
    function drawCanvas() {
        // Limpiar con color NEGRO ABSOLUTO
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#000000";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // 1. Imagen
        if (imgObject.src) {
            ctx.save();
            ctx.translate(canvas.width/2, canvas.height/2);
            ctx.scale(editorState.scale, editorState.scale);
            ctx.translate(-canvas.width/2, -canvas.height/2);
            ctx.drawImage(imgObject, editorState.x, editorState.y);
            ctx.restore();
        }

        // 2. Texto
        if (editorState.text) {
            ctx.save();
            // IMPORTANTE: Se usa la fuente seleccionada
            ctx.font = `${editorState.fontSize}px ${editorState.fontFamily}`;
            ctx.fillStyle = editorState.color;
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            ctx.fillText(editorState.text, editorState.textX, editorState.textY);
            ctx.restore();
        }
    }

    // --- CARGA DE IMAGEN CON AUTO-AJUSTE ---
    document.getElementById('imageUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = (ev) => {
                imgObject = new Image();
                imgObject.onload = () => {
                    const ratioW = canvas.width / imgObject.width;
                    const ratioH = canvas.height / imgObject.height;
                    let newScale = Math.max(ratioW, ratioH) * 1.1;

                    editorState.scale = newScale;
                    document.getElementById('zoomControl').value = newScale;
                    editorState.x = (canvas.width - imgObject.width) / 2;
                    editorState.y = (canvas.height - imgObject.height) / 2;
                    drawCanvas();
                };
                imgObject.src = ev.target.result;
            };
            reader.readAsDataURL(file);
        }
    });

    ['zoomControl', 'textInput', 'fontSize', 'fontFamily', 'fontColor'].forEach(id => {
        document.getElementById(id).addEventListener('input', (e) => {
            if (id === 'zoomControl') editorState.scale = parseFloat(e.target.value);
            if (id === 'textInput') {
                editorState.text = e.target.value;
                if(editorState.text && editorState.textX === 0) {
                    editorState.textX = canvas.width / 2;
                    editorState.textY = canvas.height / 2;
                }
            }
            if (id === 'fontSize') editorState.fontSize = parseInt(e.target.value);
            if (id === 'fontFamily') editorState.fontFamily = e.target.value;
            if (id === 'fontColor') editorState.color = e.target.value;
            drawCanvas();
        });
    });

    // --- DRAG & DROP ---
    function getPointerPos(e) {
        const rect = canvas.getBoundingClientRect();
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        // Calcular escala visual del canvas si se encoge
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        return { x: (clientX - rect.left) * scaleX, y: (clientY - rect.top) * scaleY };
    }

    function handleStart(e) {
        if(e.type === 'touchstart') e.preventDefault();
        const pos = getPointerPos(e);
        editorState.lastX = pos.x;
        editorState.lastY = pos.y;

        let hitText = false;
        if (editorState.text) {
            ctx.font = `${editorState.fontSize}px ${editorState.fontFamily}`;
            const metrics = ctx.measureText(editorState.text);
            const txtW = metrics.width;
            const txtH = editorState.fontSize;
            const left = editorState.textX - txtW/2 - 20;
            const right = editorState.textX + txtW/2 + 20;
            const top = editorState.textY - txtH/2 - 20;
            const bottom = editorState.textY + txtH/2 + 20;
            if (pos.x >= left && pos.x <= right && pos.y >= top && pos.y <= bottom) hitText = true;
        }

        if (hitText) editorState.draggingTarget = 'text';
        else if (imgObject.src) editorState.draggingTarget = 'image';
        else editorState.draggingTarget = null;
    }

    function handleMove(e) {
        if (!editorState.draggingTarget) return;
        if(e.type === 'touchmove') e.preventDefault();

        const pos = getPointerPos(e);
        const dx = pos.x - editorState.lastX;
        const dy = pos.y - editorState.lastY;

        if (editorState.draggingTarget === 'text') {
            editorState.textX += dx;
            editorState.textY += dy;
        } else if (editorState.draggingTarget === 'image') {
            editorState.x += dx;
            editorState.y += dy;
        }
        editorState.lastX = pos.x;
        editorState.lastY = pos.y;
        drawCanvas();
    }

    function handleEnd(e) { editorState.draggingTarget = null; }

    canvas.addEventListener('mousedown', handleStart);
    canvas.addEventListener('touchstart', handleStart, {passive: false});
    canvas.addEventListener('mousemove', handleMove);
    canvas.addEventListener('touchmove', handleMove, {passive: false});
    window.addEventListener('mouseup', handleEnd);
    window.addEventListener('touchend', handleEnd);

    function saveSlot() {
        if (!imgObject.src) return alert("Carga una imagen primero");
        const finalImage = canvas.toDataURL('image/jpeg', 1.0);
        slots[currentSlotIndex] = { previewData: finalImage, originalSrc: imgObject.src, editorState: { ...editorState } };
        closeEditor(); renderGrid();
    }

    // --- NAVEGACI√ìN ---
    function checkStep1Validity() {
        const btn = document.getElementById('btnNext1');
        const count = slots.filter(s => s).length;
        btn.disabled = count !== 8;
        btn.innerHTML = count === 8 ? 'Siguiente Paso <span style="font-size:1.2em">‚Üí</span>' : `Faltan ${8 - count} fotos`;
        if(count!==8) btn.style.opacity = "0.6"; else btn.style.opacity = "1";
    }

    function nextStep(n) {
        document.querySelectorAll('.step-section').forEach(el => el.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        window.scrollTo({top:0, behavior: 'smooth'});
        for(let i=1; i<=3; i++) {
            const el = document.getElementById(`step-indicator-${i}`);
            el.className = `stepper-item ${i === n ? 'active' : (i < n ? 'completed' : '')}`;
        }
    }
    function prevStep(n) { nextStep(n); }

    function validateAndNext(n) {
        if (n === 2) {
            let valid = true;
            ['ship_name','ship_surname','ship_id','ship_phone','ship_email','ship_address'].forEach(id => {
                const el = document.getElementById(id);
                if(!el.value) { el.style.borderColor = "#EF4444"; valid = false; }
                else el.style.borderColor = "#E5E7EB";
            });
            if(valid) nextStep(3); else alert("Por favor completa los campos obligatorios marcados.");
        }
    }

    function copyShippingData() {
        const checked = document.getElementById('same_data').checked;
        ['name','surname','id','phone','email','address'].forEach(f => {
            const val = document.getElementById(`ship_${f}`).value;
            const target = document.getElementById(`bill_${f}`);
            if(checked) { target.value = val; target.readOnly = true; target.style.background = "#F3F4F6"; }
            else { target.value = ""; target.readOnly = false; target.style.background = "#fff"; }
        });
    }

    // --- PROCESO CLOUDINARY ---
    async function uploadToCloudinary(base64Image) {
        const formData = new FormData();
        formData.append("file", base64Image);
        formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);

        try {
            const response = await fetch(CLOUDINARY_URL, { method: "POST", body: formData });
            if(!response.ok) throw new Error("Error Cloudinary");
            const data = await response.json();
            return data.secure_url;
        } catch (error) {
            console.error("Fallo subida:", error);
            return null;
        }
    }

    async function processOrderCloudinary() {
        const required = ['bill_name', 'bill_surname', 'bill_id', 'bill_email', 'bill_phone', 'bill_address'];
        if (required.some(id => !document.getElementById(id).value)) return alert("Completa la facturaci√≥n");
        if (!document.getElementById('terms').checked) return alert("Debes aceptar el tratamiento de datos");

        const loader = document.getElementById('loader');
        const loaderText = document.getElementById('loaderText');
        loader.style.display = 'flex';

        const nombre = document.getElementById('ship_name').value + " " + document.getElementById('ship_surname').value;
        const email = document.getElementById('ship_email').value;
        const total = (SHOP_CONFIG.price + SHOP_CONFIG.shippingCost).toFixed(2);

        try {
            loaderText.innerHTML = "Subiendo im√°genes...";
            const uploadPromises = slots.map(async (slot, index) => {
                return await uploadToCloudinary(slot.previewData);
            });

            const imageUrls = await Promise.all(uploadPromises);

            if(imageUrls.some(url => url === null)) throw new Error("Error al subir im√°genes. Verifica tu conexi√≥n.");

            loaderText.innerHTML = "Enviando pedido...";

            const templateParams = {
                cust_name: nombre,
                cust_surname: document.getElementById('ship_surname').value,
                cust_email: email,
                cust_phone: document.getElementById('ship_phone').value,
                cust_address: document.getElementById('ship_address').value,
                total_price: "$" + total,
                img1_link: imageUrls[0], img2_link: imageUrls[1], img3_link: imageUrls[2], img4_link: imageUrls[3],
                img5_link: imageUrls[4], img6_link: imageUrls[5], img7_link: imageUrls[6], img8_link: imageUrls[7]
            };

            await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);

            loader.style.display = 'none';

            const msjWA = `Hola, realic√© pedido de 8 imanes (${nombre}). Total $${total}. Las im√°genes ya fueron enviadas a tu sistema.`;
            const urlWA = `https://api.whatsapp.com/send?phone=${SHOP_CONFIG.whatsappNumber}&text=${encodeURIComponent(msjWA)}`;

            if(confirm("¬°Pedido enviado con √©xito! Ahora ser√°s redirigido a WhatsApp.")) {
                window.open(urlWA, '_blank');
            }

        } catch (error) {
            loader.style.display = 'none';
            console.error(error);
            alert("Hubo un error: " + error.message);
        }
    }
</script>

</body>
</html>